# Документация API для генерации отчётов PAL Monitoring

> PAL – акроним от Prolonged Active Life (перевод «Продолжительная и активная жизнь»)

## Введение
API позволяет асинхронно генерировать отчёты PAL Monitoring. Процесс состоит из трёх этапов:
1. Запуск генерации отчёта
2. Проверка статуса выполнения
3. Получение результатов

Для работы требуется аутентификация с помощью API-токена.

---

## Аутентификация
Все запросы должны содержать заголовок:
```http
X-Oncor-API-Token: ваш_токен_доступа
```
*Токен можно получить в личном кабинете системы Oncor*

---

## Методы API

### 1. Запуск генерации отчёта
**Запрос:**

```http
POST /api/1.0/json/pal-monitoring
Content-Type: application/json

{
  "parameters": {
    "date_start": "YYYY-MM-DD",
    "date_end": "YYYY-MM-DD"
  }
}
```

**Параметры:**

| Поле        | Обязательность | Формат      | Описание               |
|-------------|----------------|-------------|------------------------|
| date_start  | Да             | YYYY-MM-DD  | Начальная дата периода |
| date_end    | Да             | YYYY-MM-DD  | Конечная дата периода  |

**Пример ответа (200 OK):**
```json
{
    "result": [
        {
            "report_id": "550e8400-e29b-41d4-a716-446655440000",
            "status": "PROCESSING"
        }
    ]
}
```

---

### 2. Проверка статуса отчёта
**Запрос:**

```http
GET /api/1.0/json/pal-monitoring/status?report_id={report_id}
```

**Параметры URL:**

| Параметр   | Описание                              |
|------------|---------------------------------------|
| report_id  | UUID полученный при запуске генерации |

**Возможные статусы:**
- `PROCESSING`: Отчёт формируется
- `FINISHED`: Отчёт готов
- `ERROR`: Ошибка при генерации

**Пример ответа (200 OK):**
```json
{
    "result": [
        {
            "report_id": "550e8400-e29b-41d4-a716-446655440000",
            "status": "PROCESSING"
        }
    ]
}
```

---

### 3. Получение отчёта
**Запрос:**

```http
GET /api/1.0/json/pal-monitoring/download?report_id={report_id}
```

**Условия:**
- Доступно только при статусах `FINISHED` или `ERROR`

**Успешный ответ (200 OK):**
```json
{
    "result": [
        {
            "metrics": {...},
            "medical_organizations": [...]
        }
    ]
}
```

**Ответ при ошибке:**
```json
{
    "error": {
        "name": "pro.oncor.api.WorkflowException",
        "message": "У вас нет разрешения использовать pal-monitoring (Мониторинг ПАЖ) api",
        "uuid": "f2d7991f-1055-4fcb-aa49-04312b9a4e5d"
    }
}
```

---

## Пример workflow
#### 1. Запуск генерации:
```http
POST http://127.0.0.1:8080/api/1.0/json/pal-monitoring
X-Oncor-API-Token: ваш_токен
Content-Type: application/json

{
  "parameters": {
    "date_start": "2024-02-01",
    "date_end": "2024-02-15"
  }
}
```
#### 2. Проверка статуса (повторять до получения FINISHED/ERROR):
```http
GET http://127.0.0.1:8080/api/1.0/json/pal-monitoring/status?report_id=550e8400-e29b-41d4-a716-446655440000
X-Oncor-API-Token: ваш_токен
```

#### 3. Получение результатов:
```http
GET http://127.0.0.1:8080/api/1.0/json/pal-monitoring/download?report_id=550e8400-e29b-41d4-a716-446655440000
X-Oncor-API-Token: ваш_токен
```

---

## Коды ответов

| Код | Статус       | Описание              |
|-----|--------------|-----------------------|
| 200 | OK           | Успешный запрос       |
| 500 | Error        | Ошибка                |

---

## Ограничения
1. Частота запросов статуса: не чаще 1 раза/сек
2. Время жизни отчёта: 10 минут

[//]: # (## Примечание)
[//]: # (Все даты в формате UTC)

## Детализация ответа отчёта PAL Monitoring

### Общая структура ответа
```json
{
  "result": [
    {
      "metrics": {...},
      "medical_organizations": [...]
    }
  ]
}
```

| Поле                              | Тип     | Описание                           |
|-----------------------------------|---------|------------------------------------|
| result                            | Массив  | Контейнер с результатами отчёта    |
| result[0].metrics                 | Объект  | Ключевые метрики                   |
| result[0].medical_organizations   | Массив  | Справочник медицинских организаций |

---

### Блок метрик (metrics)

#### 1. stage1_detection
```json
"stage1_detection": {
  "description": "Доля выявленных на I стадии",
  "total": {
    "numerator": 359,
    "denominator": 417,
    "rate": 0.8609
  },
  "by_medical_organizations": [...]
}
```

**Структура:**
- `description` - пояснение метрики
- `total` - сводные данные:
    - `numerator` - количество случаев
    - `denominator` - общее число пациентов
    - `rate` - доля (numerator/denominator)
- `by_medical_organizations` - детализация по организациям

#### 2. five_year_survival
```json
"five_year_survival": {
  "description": "Доля 5-летней выживаемости",
  ...
}
```
Аналогичная структура для показателя выживаемости

#### 3. one_year_mortality
```json
"one_year_mortality": {
  "description": "Одногодичная летальность",
  ...
}
```
Аналогичная структура для показателя летальности

---

### Детализация по организациям (by_medical_organizations)
```json
{
  "ord_id": "#993:13",
  "numerator": 14,
  "denominator": 17,
  "rate": 0.8235
}
```

| Поле        | Тип     | Описание                                        | Пример     |
|-------------|---------|-------------------------------------------------|------------|
| ord_id      | Строка  | Уникальный идентификатор организации            | "\#993:13" |
| numerator   | Число   | Количество целевых случаев                      | 14         |
| denominator | Число   | Общее количество случаев                        | 17         |
| rate        | Число   | Рассчитанный показатель (numerator/denominator) | 0.8235     |

**Особый случай:**
```json
{
  "ord_id": "*",
  "numerator": 70,
  "denominator": 100,
  "rate": 0.7
}
```
- `"*"` в ord_id - показатели для случаев без привязки к организации

---

### Справочник организаций (medical_organizations)
```json
{
  "id": "#999:19",
  "name": "Березовская ЦГБ",
  "oid": "1.2.643.5.1.13.13.12.2.66.6868",
  "ogrn": "1026600669765"
}
```

| Поле   | Тип     | Описание                                               | Пример значения                  |
|--------|---------|--------------------------------------------------------|----------------------------------|
| id     | Строка  | Идентификатор для связи с метриками                    | "\#999:19"                       |
| name   | Строка  | Полное название организации                            | "Березовская ЦГБ"                |
| oid    | Строка  | [OID](https://oid-info.com/) в системе здравоохранения | "1.2.643.5.1.13.13.12.2.66.6868" |
| ogrn   | Строка  | [ОГРН](https://egrul.nalog.ru/) организации            | "1026600669765"                  |

**Особый случай:**
```json
{
  "id": "*",
  "name": "Без организации"
}
```
- Отсутствуют oid и ogrn
- Используется для агрегированных данных без привязки

---

## Пример интерпретации данных
Для организации `#999:19`:
```json
{
  "id": "#999:19",
  "name": "Березовская ЦГБ",
  ...
}
```
В метрике `stage1_detection`:
```json
{
  "ord_id": "#999:19",
  "numerator": 22,
  "denominator": 26,
  "rate": 0.8461
}
```
**Расшифровка:**
- В Березовской ЦГБ из 26 случаев заболевания:
    - 22 выявлены на I стадии
    - Доля выявления: 84.61%

---

## Особенности формата
1. Точность вычислений:
    - Коэффициенты представлены с плавающей точкой
    - Пример: 0.8235294222831726 ≈ 82.35%

2. Временные метки:
    - Актуальность данных соответствует датам из запроса

3. Особые значения:
    - При нулевом denominator возвращается rate = 0
    - При ошибках в rate = null
